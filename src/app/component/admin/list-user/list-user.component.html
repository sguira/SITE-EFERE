<div class="container py-4">

  <h1 class="mb-4 text-primary">Gestion des Utilisateurs</h1>

  <div
    class="mb-4 d-flex flex-wrap justify-content-between align-items-center gap-3">

    <div class="input-group search-input-group flex-grow-1"
      style="max-width: 350px;">
      <span class="input-group-text bg-light border-end-0"><i
          class="bi bi-search text-secondary"></i></span>
      <input
        type="text"
        class="form-control border-start-0 ps-0"
        placeholder="Rechercher par nom..."
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchChange()">
    </div>

    <div class="btn-group" role="group" aria-label="Options de tri">
      <button
        type="button"
        class="btn btn-outline-secondary"
        [class.active]="sortColumn === 'name'"
        (click)="sortData({active: 'name', direction: sortDirection === 'asc' && sortColumn === 'name' ? 'desc' : 'asc'})">
        Nom
        <i class="bi" [ngClass]="{
                    'bi-sort-alpha-down': sortColumn === 'name' && sortDirection === 'asc',
                    'bi-sort-alpha-up': sortColumn === 'name' && sortDirection === 'desc'
                }"></i>
      </button>
      <button
        type="button"
        class="btn btn-outline-secondary"
        [class.active]="sortColumn === 'createdAt'"
        (click)="sortData({active: 'createdAt', direction: sortDirection === 'asc' && sortColumn === 'createdAt' ? 'desc' : 'asc'})">
        Date d'inscription
        <i class="bi" [ngClass]="{
                    'bi-sort-numeric-down': sortColumn === 'createdAt' && sortDirection === 'asc',
                    'bi-sort-numeric-up': sortColumn === 'createdAt' && sortDirection === 'desc'
                }"></i>
      </button>
    </div>

    <button class="btn btn-primary ms-auto">
      <i class="bi bi-person-plus me-2"></i> Ajouter Utilisateur
    </button>
  </div>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"
    [@cardListAnimation]>

    <div class="col" *ngFor="let user of displayedUsers">
      <div class="card h-100 shadow-sm user-card">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-3">
            <div class="avatar-circle me-3"
              [class.bg-info]="user.role === 'User'"
              [class.bg-warning]="user.role === 'Premium'"
              [class.bg-danger]="user.role === 'Admin'">
              <i class="bi bi-person-fill text-white"></i>
            </div>
            <div>
              <h5 class="card-title mb-0">{{ user.name }}</h5>
              <small class="text-muted">ID: {{ user.id }}</small>
            </div>
            <span class="badge ms-auto" [ngClass]="{
                            'bg-danger': user.role === 'Admin',
                            'bg-warning text-dark': user.role === 'Premium',
                            'bg-success': user.role === 'User'
                        }">{{ user.role }}</span>
          </div>

          <p class="card-text mb-2"><i
              class="bi bi-envelope me-2 text-secondary"></i> {{ user.email
            }}</p>
          <p class="card-text mb-3"><i
              class="bi bi-calendar-event me-2 text-secondary"></i> Inscrit le:
            {{ user.createdAt | date:'shortDate' }}</p>

          <div class="mt-auto pt-2 border-top d-flex justify-content-end">
            <button class="btn btn-sm btn-outline-info me-2"
              (click)="openRenouvellementModal(user.email)" title="Modifier">
              <i class="bi bi-pencil"></i> Rénouveller
            </button>
            <button class="btn btn-sm btn-outline-danger" title="Supprimer">
              <i class="bi bi-trash"></i> Supprimer
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12" *ngIf="displayedUsers.length === 0">
      <div class="alert alert-info text-center py-4" role="alert">
        <i class="bi bi-info-circle me-2"></i> Aucun utilisateur trouvé
        correspondant à la recherche.
      </div>
    </div>
  </div>

  <nav *ngIf="totalPages > 1" class="mt-5 d-flex justify-content-center">
    <ul class="pagination shadow-sm">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="onPageChange(1)" aria-label="First">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="onPageChange(currentPage - 1)"
          aria-label="Previous">
          <span aria-hidden="true">&lsaquo;</span>
        </a>
      </li>

      <li class="page-item" *ngFor="let page of pageNumbers"
        [class.active]="page === currentPage">
        <a class="page-link" (click)="onPageChange(page)">{{ page }}</a>
      </li>

      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <a class="page-link" (click)="onPageChange(currentPage + 1)"
          aria-label="Next">
          <span aria-hidden="true">&rsaquo;</span>
        </a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <a class="page-link" (click)="onPageChange(totalPages)"
          aria-label="Last">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    </ul>
  </nav>

  <app-glass-modal [isOpen]="showModal" *ngIf="showModal"
    (closed)="closed($event)">
    <div class="p-5">
      <div class="form">
        <h2>Renouvellement de Contrat</h2>
        <form (ngSubmit)="submitRenouvellement()"
          [formGroup]="suscriptionForm!">
          <div class="mb-3">
            <label for="userId" class="form-label">ID Utilisateur</label>
            <input type="text" id="userId" class="form-control"
              formControlName="email" name="userId" required>
          </div>
          <div class="mb-3">
            <span>Sélectionnez un plan d'abonnement</span>
            <div class=" d-flex flex-row overflow-x-scroll " >
              <div *ngFor="let item of periodicite" class="me-3 col-6">
                <div class="d-flex flex-column border p-3 mb-2"
                  tabindex="0"
                  role="button"
                  (click)="suscriptionForm?.get('plan')?.setValue(item.id)"
                  (keydown.enter)="suscriptionForm?.get('plan')?.setValue(item.id)"
                  [class.border-primary]="
                    suscriptionForm?.get('plan')?.value === item.id">
                  <span> Nombre : {{item!.duree}} jrs</span>
                <span> Montant: {{ item.prix }} </span>
                </div>

              </div>
            </div>

          </div>
          <button type="submit" class="btn btn-primary"
            [disabled]="!suscriptionForm?.valid">Renouveler</button>
          <button type="button" class="btn btn-secondary ms-2"
            (click)="closeModal()">Annuler</button>
        </form>
      </div>
    </div>
  </app-glass-modal>

</div>
